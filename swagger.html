<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WADS-W3 API Documentation</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/5.17.14/swagger-ui.min.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
    .topbar { background: #1a1a2e; padding: 14px 24px; display: flex; align-items: center; gap: 12px; }
    .topbar-logo { font-size: 22px; font-weight: 700; color: #fff; letter-spacing: -0.5px; }
    .topbar-badge { background: #4f46e5; color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 99px; font-weight: 600; }
    .topbar-subtitle { color: #a0aec0; font-size: 13px; margin-left: auto; }
    #swagger-ui { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .swagger-ui .topbar { display: none; }
    .swagger-ui .info .title { font-size: 28px !important; }
  </style>
</head>
<body>

<div class="topbar">
  <div class="topbar-logo">ðŸ”¥ WADS-W3</div>
  <span class="topbar-badge">v1.0.0</span>
  <span class="topbar-subtitle">REST API Â· Firebase Auth Â· Next.js 14</span>
</div>

<div id="swagger-ui"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/5.17.14/swagger-ui-bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/5.17.14/swagger-ui-standalone-preset.min.js"></script>
<script>
const spec = {
  openapi: "3.0.0",
  info: {
    title: "WADS-W3 API",
    version: "1.0.0",
    description: `## WADS Week 3 Assignment â€” REST API with Firebase Auth\n\nThis API provides user management and authentication endpoints for a Next.js app integrated with **Firebase Authentication**.\n\n### Auth Flow\n1. Client signs in via Firebase (email/password or Google)\n2. Client gets \`idToken\` via \`await user.getIdToken()\`\n3. Client calls \`POST /api/session\` with \`Authorization: Bearer <idToken>\`\n4. Server verifies via **Firebase Admin SDK** (\`adminAuth.verifyIdToken\`) and sets HttpOnly \`session\` cookie\n5. To logout: client calls \`POST /api/logout\` â€” cookie is expired and cleared\n\n### Base URL\n\`http://localhost:3000\``,
    contact: { name: "Student", email: "lkencana06@gmail.com" }
  },
  servers: [
    { url: "http://localhost:3000", description: "Local Development" }
  ],
  tags: [
    { name: "Auth", description: "Session creation (Firebase Admin verified) and logout" },
    { name: "Users", description: "Full CRUD on user records (hardcoded dummy data)" }
  ],
  components: {
    securitySchemes: {
      BearerAuth: {
        type: "http",
        scheme: "bearer",
        bearerFormat: "Firebase ID Token",
        description: "Firebase `idToken` from `await user.getIdToken()`. Pass as `Authorization: Bearer <token>`"
      }
    },
    schemas: {
      User: {
        type: "object",
        properties: {
          id:        { type: "string",  example: "1" },
          uid:       { type: "string",  example: "firebase-uid-001" },
          name:      { type: "string",  example: "Alice Johnson" },
          email:     { type: "string",  example: "alice@example.com" },
          role:      { type: "string",  enum: ["admin", "user"], example: "user" },
          createdAt: { type: "string",  format: "date-time", example: "2024-01-15T08:00:00Z" },
          lastLogin: { type: "string",  format: "date-time", example: "2024-06-01T10:30:00Z" }
        }
      },
      ErrorResponse: {
        type: "object",
        properties: {
          success: { type: "boolean", example: false },
          message: { type: "string",  example: "Resource not found" }
        }
      }
    }
  },
  paths: {

    /* â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    "/api/session": {
      post: {
        summary: "Create Session",
        tags: ["Auth"],
        security: [{ BearerAuth: [] }],
        description:
          "Accepts a Firebase ID Token in the `Authorization` header. Calls **`adminAuth.verifyIdToken(idToken, true)`** (Firebase Admin SDK) to validate the token. On success, stores the raw `idToken` as an **HttpOnly + Secure** cookie named `session`.\n\n" +
          "**Client snippet (from your login page):**\n```ts\nconst idToken = await user.getIdToken();\nawait fetch('/api/session', {\n  method: 'POST',\n  headers: { Authorization: `Bearer ${idToken}` }\n});\n```\n\n" +
          "**Important:** The header must start with `Bearer ` (space included) otherwise the server returns 401.",
        parameters: [
          {
            in: "header",
            name: "Authorization",
            required: true,
            schema: { type: "string", example: "Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Ij..." },
            description: "Format: `Bearer <Firebase idToken>`"
          }
        ],
        responses: {
          200: {
            description: "Token verified. `session` HttpOnly cookie is set.",
            headers: {
              "Set-Cookie": {
                schema: { type: "string" },
                description: "`session=<idToken>; Path=/; HttpOnly; Secure`"
              }
            },
            content: {
              "application/json": {
                schema: {
                  type: "object",
                  properties: { status: { type: "string", example: "success" } }
                },
                example: { status: "success" }
              }
            }
          },
          401: {
            description: "Missing `Authorization` header or it does not start with `Bearer `",
            content: {
              "application/json": {
                schema: { type: "object", properties: { error: { type: "string" } } },
                example: { error: "Unauthorized" }
              }
            }
          },
          500: {
            description: "Firebase token verification threw an error (expired, revoked, or malformed token)",
            content: {
              "application/json": {
                schema: { type: "object", properties: { error: { type: "string" } } },
                example: { error: "Firebase: Error (auth/id-token-expired)." }
              }
            }
          }
        }
      }
    },

    "/api/logout": {
      post: {
        summary: "Logout (Clear Session Cookie)",
        tags: ["Auth"],
        description:
          "Clears the `session` cookie by setting it to an **empty string** with `expires: new Date(0)` (Unix epoch), effectively invalidating it immediately. No request body or auth header needed.\n\n" +
          "**Client snippet (from your logout button):**\n```ts\nawait fetch('/api/logout', { method: 'POST' });\nrouter.push('/login');\n```",
        responses: {
          200: {
            description: "Session cookie cleared. Redirect client to `/login`.",
            headers: {
              "Set-Cookie": {
                schema: { type: "string" },
                description: "`session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure`"
              }
            },
            content: {
              "application/json": {
                schema: { type: "object", properties: { message: { type: "string" } } },
                example: { message: "Logged out" }
              }
            }
          }
        }
      }
    },

    /* â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    "/api/users": {
      get: {
        summary: "Get All Users",
        description: "Returns all registered users. Uses hardcoded dummy data for this assignment. In production this would query your database and require admin-level auth.",
        tags: ["Users"],
        responses: {
          200: {
            description: "Array of all users",
            content: {
              "application/json": {
                schema: {
                  type: "object",
                  properties: {
                    success: { type: "boolean", example: true },
                    total:   { type: "integer", example: 3 },
                    data:    { type: "array", items: { $ref: "#/components/schemas/User" } }
                  }
                },
                example: {
                  success: true, total: 3,
                  data: [
                    { id: "1", uid: "firebase-uid-001", name: "Alice Johnson",  email: "alice@example.com", role: "admin", createdAt: "2024-01-15T08:00:00Z", lastLogin: "2024-06-01T10:30:00Z" },
                    { id: "2", uid: "firebase-uid-002", name: "Bob Smith",       email: "bob@example.com",   role: "user",  createdAt: "2024-02-20T09:00:00Z", lastLogin: "2024-06-02T14:20:00Z" },
                    { id: "3", uid: "firebase-uid-003", name: "Carol White",     email: "carol@example.com", role: "user",  createdAt: "2024-03-10T11:00:00Z", lastLogin: "2024-05-30T09:45:00Z" }
                  ]
                }
              }
            }
          }
        }
      },
      post: {
        summary: "Create User",
        description: "Creates a new user profile record after a successful Firebase signup. The `uid` must match the Firebase UID returned from Auth.",
        tags: ["Users"],
        requestBody: {
          required: true,
          content: {
            "application/json": {
              schema: {
                type: "object",
                required: ["uid", "name", "email"],
                properties: {
                  uid:   { type: "string", example: "firebase-uid-999" },
                  name:  { type: "string", example: "John Doe" },
                  email: { type: "string", example: "john@example.com" },
                  role:  { type: "string", enum: ["admin", "user"], example: "user", default: "user" }
                }
              }
            }
          }
        },
        responses: {
          201: {
            description: "User record created",
            content: {
              "application/json": {
                schema: {
                  type: "object",
                  properties: {
                    success: { type: "boolean", example: true },
                    message: { type: "string",  example: "User created successfully" },
                    data:    { $ref: "#/components/schemas/User" }
                  }
                }
              }
            }
          },
          400: {
            description: "Missing required fields",
            content: {
              "application/json": {
                schema: { $ref: "#/components/schemas/ErrorResponse" },
                example: { success: false, message: "uid, name, and email are required" }
              }
            }
          }
        }
      }
    },

    "/api/users/{id}": {
      get: {
        summary: "Get User by ID",
        description: "Fetches a single user by their internal numeric ID.",
        tags: ["Users"],
        parameters: [{
          in: "path", name: "id", required: true,
          schema: { type: "string" }, example: "1",
          description: "Internal user record ID"
        }],
        responses: {
          200: {
            description: "User found",
            content: {
              "application/json": {
                schema: {
                  type: "object",
                  properties: { success: { type: "boolean" }, data: { $ref: "#/components/schemas/User" } }
                },
                example: {
                  success: true,
                  data: { id: "1", uid: "firebase-uid-001", name: "Alice Johnson", email: "alice@example.com", role: "admin", createdAt: "2024-01-15T08:00:00Z", lastLogin: "2024-06-01T10:30:00Z" }
                }
              }
            }
          },
          404: {
            description: "User not found",
            content: { "application/json": { schema: { $ref: "#/components/schemas/ErrorResponse" }, example: { success: false, message: "User not found" } } }
          }
        }
      },
      put: {
        summary: "Update User by ID",
        description: "Updates one or more user fields. `id` and `uid` are **read-only** â€” they are stripped from the request body even if provided.",
        tags: ["Users"],
        parameters: [{
          in: "path", name: "id", required: true,
          schema: { type: "string" }, example: "1",
          description: "Internal user record ID"
        }],
        requestBody: {
          required: true,
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  name:  { type: "string", example: "Alice Updated" },
                  email: { type: "string", example: "alice.new@example.com" },
                  role:  { type: "string", enum: ["admin", "user"], example: "admin" }
                }
              }
            }
          }
        },
        responses: {
          200: {
            description: "User updated",
            content: {
              "application/json": {
                schema: {
                  type: "object",
                  properties: {
                    success: { type: "boolean", example: true },
                    message: { type: "string",  example: "User updated successfully" },
                    data:    { $ref: "#/components/schemas/User" }
                  }
                }
              }
            }
          },
          404: {
            description: "User not found",
            content: { "application/json": { schema: { $ref: "#/components/schemas/ErrorResponse" }, example: { success: false, message: "User not found" } } }
          }
        }
      },
      delete: {
        summary: "Delete User by ID",
        description: "Removes a user record by internal ID. In production, also call `adminAuth.revokeRefreshTokens(uid)` to invalidate their Firebase session.",
        tags: ["Users"],
        parameters: [{
          in: "path", name: "id", required: true,
          schema: { type: "string" }, example: "2",
          description: "Internal user record ID"
        }],
        responses: {
          200: {
            description: "User deleted",
            content: {
              "application/json": {
                schema: {
                  type: "object",
                  properties: {
                    success: { type: "boolean", example: true },
                    message: { type: "string",  example: "User with id 2 deleted successfully" },
                    data: {
                      type: "object",
                      properties: { deletedUser: { $ref: "#/components/schemas/User" } }
                    }
                  }
                }
              }
            }
          },
          404: {
            description: "User not found",
            content: { "application/json": { schema: { $ref: "#/components/schemas/ErrorResponse" }, example: { success: false, message: "User not found" } } }
          }
        }
      }
    }
  }
};

window.onload = () => {
  SwaggerUIBundle({
    spec,
    dom_id: "#swagger-ui",
    presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
    layout: "StandaloneLayout",
    deepLinking: true,
    displayRequestDuration: true,
    tryItOutEnabled: true,
    defaultModelsExpandDepth: 2,
    defaultModelExpandDepth: 2,
    syntaxHighlight: { theme: "monokai" },
    persistAuthorization: true
  });
};
</script>
</body>
</html>